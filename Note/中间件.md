# 中间件

## 使用场景

RabbitMQ

1. QUEUE ： 储存数据

2. EXCHANGE：接收请求，转存数据到哪个queue

3. BIND 介绍到请求后存储到哪里去

4. CONSUMER

5. PRODUCTOR

   ## 使用场景

   解决分布式事务问题：例如外卖点单的点单系统 和接单配送系统的一致性

   ### 如果先生成订单插入（service1），再远程调用生成运单插入（service2） 的分布式事务问题

   当service1成功，但是订单数据库事务提交失败回滚，那么service2不会回滚

   当service1失败，然后触发@transactional， 但是service2的调用不会回滚

   ### 解决办法

   使用mq来接受service1的消息

   但必须保证

   ​	问题1：service1数据一定成功发送到MQ,

   ​	问题2：service2一定要消费掉数据

   为了解决1

   ​	用一张表记录每一条发往MQ的数据以及它的发送状态，开启mq的消息确认机制，只有收没收到确认，那么就一直往mq发数据；发送mq消息可以通过直接发送或者后台定时任务发送

   为了解决2

   ​	开启手动ACK，接收端的应答，控制重发/清除/丢弃；幂等性，防止重复数据；消费掉数据，通知MQ清除消息。
   
   ## 中间件的架构设计
   
   中间件的几种部署方式
   
   1. 主从共享数据：多个服务器共享一个主服务器的数据，都从它里面插入或者取出
   2. 主从同步的部署：生产者发送数据之后，同步到其他服务器上面，一般都有一个主服务器，只有主服务器先有数据了，再给其他同步上
   3. 多主机群同步的部署：基于上门，每个服务器都可以插入数据，再给其他同步
   4. 舵主集群转发：插入数据到一个服务器之后，把插入的元数据同步，其他消费者就可以通过这些描述去指定服务器寻找消息